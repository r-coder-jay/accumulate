# 多人编辑场景下的数据覆盖问题

tag：并发控制、多人编辑



场景：多人同时编辑一条数据时，最后的写入者会覆盖前者的数据，会导致前者对于编辑操作存疑。



解决思路：该问题的根本原因有两个，一是用户看到的数据并未及时更新，无法察觉其他用户的修改；二是多人同时编辑可以看做是并发操作，需要引入并发控制。



方案一：悲观锁

编辑时，在应用层面对相关数据上互斥锁或者读写锁，拒绝多人同时进入同一数据的编辑状态。



方案二：乐观锁

对数据添加版本号字段，保存时，对版本号进行校验，如果不同，则反馈用户。



方案三：实时更新 + 并发控制

如果对用户体验有极致要求，可以使用该方案。由于该场景较少，不予讨论。



方案对比：

方案一，需要在用户进入编辑状态时上锁。如果之前的编辑交互设计，无法判断用户的编辑状态，那么该方案需要调整交互，可能会对用户操作习惯有影响。

方案二，基本不用调整交互，只需要在保存时给出提示，对用户的操作习惯无任何影响。但是需要存储数据的版本号，数据表需要新增字段。



本文最终采取方案二



详细方案设计：

- 数据表增加版本号字段。
- 新增接口OptVerPo，内部包含getOptVer和setOptVer两个方法。需要做版本校验的po类，必须实现该接口。
- 使用mybatisplus的innerInterceptor拦截器，识别到参数类型为OptVerPo，则先查询，进行版本校验，若版本号不同，则抛出异常。

